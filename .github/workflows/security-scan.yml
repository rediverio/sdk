# =============================================================================
# Security Scanning with Rediver Agent
# =============================================================================
# Runs security scans on pull requests and pushes to main
#
# Features:
#   - SAST with Semgrep (dataflow/taint tracking)
#   - Secret detection with Gitleaks
#   - SCA with Trivy
#   - Automatic PR comments for findings
#   - Results pushed to Rediver platform (optional)
# =============================================================================

name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write  # For PR comments
      security-events: write  # For SARIF upload

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff-based scanning

      - name: Run Rediver Agent
        uses: docker://ghcr.io/rediverio/rediver-agent:ci
        with:
          args: >-
            -tools semgrep,gitleaks,trivy
            -target .
            -auto-ci
            -comments
            -verbose
            -json
            -output /github/workspace/results.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REDIVER_API_URL: ${{ secrets.REDIVER_API_URL }}
          REDIVER_API_KEY: ${{ secrets.REDIVER_API_KEY }}

      - name: Upload scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: results.json
          retention-days: 30

      # Optional: Upload SARIF to GitHub Security tab
      - name: Upload SARIF
        if: always() && hashFiles('results.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

  # Separate job for container scanning
  container-scan:
    runs-on: ubuntu-latest
    needs: [scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build -t rediver-agent:scan -f docker/Dockerfile .

      - name: Scan container image
        uses: docker://ghcr.io/rediverio/rediver-agent:ci
        with:
          args: >-
            -tool trivy-image
            -target rediver-agent:scan
            -verbose
            -json
            -output /github/workspace/container-results.json
        env:
          REDIVER_API_URL: ${{ secrets.REDIVER_API_URL }}
          REDIVER_API_KEY: ${{ secrets.REDIVER_API_KEY }}

      - name: Upload container scan results
        uses: actions/upload-artifact@v4
        with:
          name: container-scan-results
          path: container-results.json
          retention-days: 30
