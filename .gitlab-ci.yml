# =============================================================================
# GitLab CI/CD Configuration for Exploop Agent
# =============================================================================
# Includes:
#   - Security scanning (SAST, Secret, SCA)
#   - Docker image building
#   - Container scanning
#
# Required CI/CD Variables:
#   - API_URL: Platform URL
#   - API_KEY: API key
# =============================================================================

stages:
  - test
  - security
  - build
  - container-scan

variables:
  # Docker settings
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

  # Image names
  CI_REGISTRY_IMAGE: ${CI_REGISTRY}/${CI_PROJECT_PATH}

  # Agent settings
  AGENT_ID: "gitlab-${CI_PROJECT_ID}"

# =============================================================================
# Security Scanning
# =============================================================================

security-scan:
  stage: security
  image: ghcr.io/exploopio/agent:ci
  variables:
    GIT_DEPTH: 0 # Full clone for diff-based scanning
  script:
    - |
      agent \
        -tools semgrep,gitleaks,trivy \
        -target . \
        -auto-ci \
        -comments \
        -verbose \
        -json \
        -output results.json
  artifacts:
    paths:
      - results.json
    reports:
      # GitLab security report integration
      sast: results.json
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# SAST only (faster, for quick feedback)
sast-quick:
  stage: security
  image: ghcr.io/exploopio/agent:ci
  script:
    - |
      agent \
        -tool semgrep \
        -target . \
        -auto-ci \
        -verbose
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# Secret scanning
secret-scan:
  stage: security
  image: ghcr.io/exploopio/agent:ci
  script:
    - |
      agent \
        -tool gitleaks \
        -target . \
        -verbose
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# =============================================================================
# Docker Build
# =============================================================================

.docker-build-template: &docker-build
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

build-full:
  <<: *docker-build
  script:
    - |
      docker build \
        --build-arg VERSION=${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA} \
        -t ${CI_REGISTRY_IMAGE}:latest \
        -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} \
        -f docker/Dockerfile .
    - docker push ${CI_REGISTRY_IMAGE}:latest
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}

build-slim:
  <<: *docker-build
  script:
    - |
      docker build \
        --build-arg VERSION=${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA} \
        -t ${CI_REGISTRY_IMAGE}:slim \
        -f docker/Dockerfile.slim .
    - docker push ${CI_REGISTRY_IMAGE}:slim

build-ci:
  <<: *docker-build
  script:
    - |
      docker build \
        --build-arg VERSION=${CI_COMMIT_TAG:-$CI_COMMIT_SHORT_SHA} \
        -t ${CI_REGISTRY_IMAGE}:ci \
        -f docker/Dockerfile.ci .
    - docker push ${CI_REGISTRY_IMAGE}:ci

# =============================================================================
# Container Scanning
# =============================================================================

container-scan:
  stage: container-scan
  image: ghcr.io/exploopio/agent:ci
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - |
      agent \
        -tool trivy-image \
        -target ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} \
        -verbose \
        -json \
        -output container-results.json
  artifacts:
    paths:
      - container-results.json
    reports:
      container_scanning: container-results.json
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - build-full
