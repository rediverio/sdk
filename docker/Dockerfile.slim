# =============================================================================
# Rediver Agent - Slim Image (No Pre-installed Tools)
# =============================================================================
# Minimal image containing only the rediver-agent binary.
# Security tools must be:
# - Mounted from host: -v /usr/local/bin/semgrep:/usr/local/bin/semgrep
# - Or installed at runtime
#
# Usage:
#   docker build -t rediver-agent:slim -f docker/Dockerfile.slim .
#   docker run --rm -v $(pwd):/scan -v /usr/local/bin/semgrep:/usr/local/bin/semgrep \
#       rediver-agent:slim -tool semgrep -target /scan
# =============================================================================

# -----------------------------------------------------------------------------
# Stage 1: Build
# -----------------------------------------------------------------------------
FROM golang:1.25-alpine AS builder

RUN apk add --no-cache git ca-certificates tzdata

WORKDIR /build

# Copy all source code (ensures local packages are available)
COPY . .

# Set GOPRIVATE to skip proxy verification for this module
ENV GOPRIVATE=github.com/rediverio/*

# Download external dependencies
RUN go mod download

# Build with optimizations
ARG TARGETOS=linux
ARG TARGETARCH=amd64
ARG VERSION=dev
RUN CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build \
    -ldflags="-w -s -X main.appVersion=${VERSION}" \
    -o /build/rediver-agent \
    ./cmd/rediver-agent

# -----------------------------------------------------------------------------
# Stage 2: Minimal runtime (distroless)
# -----------------------------------------------------------------------------
FROM gcr.io/distroless/static-debian12:nonroot

LABEL org.opencontainers.image.title="Rediver Agent Slim"
LABEL org.opencontainers.image.description="Minimal security scanning agent (tools not included)"

# Copy binary
COPY --from=builder /build/rediver-agent /usr/local/bin/
COPY --from=builder /usr/share/zoneinfo /usr/share/zoneinfo
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

WORKDIR /scan

ENTRYPOINT ["rediver-agent"]
CMD ["-help"]
