# =============================================================================
# Rediver Agent - Slim Image (No Pre-installed Tools)
# =============================================================================
FROM golang:1.25-alpine AS builder

RUN apk add --no-cache git ca-certificates tzdata

WORKDIR /src

COPY . .

# Add replace directive to use local packages (avoids module path mismatch)
RUN go mod edit -replace github.com/rediverio/rediver-sdk=./

ARG TARGETOS=linux
ARG TARGETARCH=amd64
ARG VERSION=dev
RUN CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build \
    -ldflags="-w -s -X main.appVersion=${VERSION}" \
    -o /src/rediver-agent \
    ./cmd/rediver-agent

# -----------------------------------------------------------------------------
# Stage 2: Minimal runtime (distroless)
# -----------------------------------------------------------------------------
FROM gcr.io/distroless/static-debian12:nonroot

LABEL org.opencontainers.image.title="Rediver Agent Slim"
LABEL org.opencontainers.image.description="Minimal security scanning agent"

COPY --from=builder /src/rediver-agent /usr/local/bin/
COPY --from=builder /usr/share/zoneinfo /usr/share/zoneinfo
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

WORKDIR /scan

ENTRYPOINT ["rediver-agent"]
CMD ["-help"]
